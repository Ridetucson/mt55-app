<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ride Tucson • Reparaciones</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0c5730">
<link rel="icon" sizes="192x192" href="icon-192.png">
<style>
:root{
  --bg:#f6f7f6; --fg:#101411; --muted:#6b726e; --card:#ffffff;
  --accent:#0c5730; --accent-2:#0f6a3a; --danger:#b00020; --ok:#0c5730;
  --warn:#a35a00; --border:#e7ece9;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;}
header{
  position:sticky; top:0; z-index:10; display:flex; gap:.75rem; align-items:center;
  padding:.75rem 1rem; background:var(--card); border-bottom:1px solid var(--border);
}
header img{height:34px;width:auto}
header h1{font-size:1.1rem; margin:0; letter-spacing:.3px}
.container{max-width:1100px; margin:0 auto; padding:1rem}
.controls{
  display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:.5rem; margin:.75rem 0;
}
.controls input, .controls select, .controls button{
  padding:.65rem .7rem; border:1px solid var(--border); border-radius:.55rem; background:#fff;
}
.controls button.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
.controls button.ghost{background:#fff}
.controls button.danger{background:var(--danger); color:#fff; border-color:var(--danger)}
.controls button:disabled{opacity:.5}
.grid{
  display:grid; gap:.6rem;
}
.card{
  background:var(--card); border:1px solid var(--border); border-radius:.8rem; padding:1rem;
}
form#orderForm{
  display:grid; grid-template-columns: repeat(6, 1fr); gap:.6rem;
}
form#orderForm input, form#orderForm select, form#orderForm textarea{
  padding:.6rem .7rem; border:1px solid var(--border); border-radius:.55rem; width:100%;
}
form#orderForm textarea{grid-column: span 6; min-height:80px; resize:vertical}
.form-span-2{grid-column: span 2}
.form-span-3{grid-column: span 3}
.form-span-6{grid-column: span 6}
.badge{display:inline-block; font-size:.78rem; padding:.28rem .5rem; border-radius:.5rem; border:1px solid var(--border); background:#fafafa}
.badge.paid{background:#e9f6ee; color:var(--ok); border-color:#cfe8d7}
.badge.unpaid{background:#fff3f3; color:#8b1a1a; border-color:#f1d0d0}
.table{width:100%; border-collapse:collapse}
.table th, .table td{padding:.6rem .5rem; border-bottom:1px solid var(--border); text-align:left; font-size:.95rem}
.table tr:hover{background:#fafafa}
.row-actions{display:flex; gap:.4rem}
.kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:.8rem; background:#eee; padding:.05rem .35rem; border-radius:.35rem; border:1px solid #ddd}
footer{color:var(--muted); font-size:.85rem; padding:1rem; text-align:center}
@media(max-width:900px){
  .controls{grid-template-columns: 1fr 1fr}
  form#orderForm{grid-template-columns: repeat(2, 1fr)}
}
@media print{
  header, .controls, #listCard, footer {display:none}
  #printArea{display:block}
  body{background:#fff}
}
#printArea{display:none}
.small{font-size:.88rem; color:var(--muted)}
</style>
</head>
<body>
<header>
  <img src="icon-72.png" alt="RT">
  <h1>Ride Tucson • Reparaciones</h1>
</header>

<div class="container grid">
  <section id="createCard" class="card">
    <h2 style="margin:0 0 .5rem 0; font-size:1.05rem;">Nueva orden / Editar</h2>
    <form id="orderForm">
      <input class="form-span-2" id="cliente" placeholder="Cliente *" required>
      <input id="telefono" placeholder="Teléfono">
      <input id="email" type="email" placeholder="Email">
      <input id="equipo" placeholder="Bici/Equipo *" required>
      <input id="orden" placeholder="Orden #" >
      <input id="fechaIngreso" type="date" placeholder="Fecha ingreso *" required>
      <input id="fechaEstimada" type="date" placeholder="Entrega estimada">
      <select id="estado">
        <option value="Recibido">Recibido</option>
        <option value="En Proceso">En Proceso</option>
        <option value="Listo">Listo</option>
        <option value="Entregado">Entregado</option>
      </select>
      <select id="pagada">
        <option value="No">No pagada</option>
        <option value="Sí">Pagada</option>
      </select>
      <input id="monto" type="number" step="0.01" placeholder="Monto total">
      <input id="abono" type="number" step="0.01" placeholder="Abono">
      <input id="saldo" type="number" step="0.01" placeholder="Saldo" disabled>
      <input id="metodo" placeholder="Método de pago (efectivo, tarjeta, etc.)">
      <textarea id="descripcion" placeholder="Descripción / Notas *" required></textarea>
      <div class="form-span-6" style="display:flex; gap:.5rem; flex-wrap:wrap">
        <button type="submit" class="primary">Guardar</button>
        <button type="button" id="resetBtn" class="ghost">Limpiar</button>
        <button type="button" id="printBtn" class="ghost">Imprimir ticket</button>
        <span id="saveInfo" class="small"></span>
      </div>
      <input type="hidden" id="editingId">
    </form>
  </section>

  <section class="card">
    <div class="controls">
      <input id="q" placeholder="Buscar (cliente, orden, descripción)">
      <select id="filterEstado">
        <option value="">Estado: Todos</option>
        <option>Recibido</option><option>En Proceso</option><option>Listo</option><option>Entregado</option>
      </select>
      <select id="filterPagada">
        <option value="">Pago: Todos</option>
        <option value="Sí">Pagada</option>
        <option value="No">No pagada</option>
      </select>
      <div style="display:flex; gap:.4rem">
        <button id="exportBtn" class="ghost">Exportar CSV</button>
        <label class="ghost" style="display:inline-flex; align-items:center; gap:.3rem; padding:.6rem .7rem; border:1px solid var(--border); border-radius:.55rem; cursor:pointer">
          Importar CSV
          <input type="file" id="importFile" accept=".csv" style="display:none">
        </label>
      </div>
    </div>

    <div id="listCard">
      <table class="table" id="ordersTable">
        <thead>
          <tr>
            <th>Orden</th><th>Cliente</th><th>Equipo</th><th>Ingreso</th><th>Estado</th><th>Pago</th><th>Monto</th><th>Acciones</th>
          </tr>
        </thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </div>
  </section>
</div>

<div id="printArea"></div>

<footer>Funciona sin internet. Para instalar como App: menú del navegador → “Agregar a pantalla de inicio”.</footer>

<script src="https://cdn.jsdelivr.net/npm/idb@7/build/esm/index.js" type="module"></script>
<script type="module">
import { openDB } from 'https://cdn.jsdelivr.net/npm/idb@7/+esm'

const db = await openDB('rt-reparaciones', 1, {
  upgrade(db){
    const store = db.createObjectStore('orders', {keyPath:'id', autoIncrement:true})
    store.createIndex('by_cliente','cliente')
    store.createIndex('by_orden','orden')
  }
})

const el = id => document.getElementById(id)
const form = el('orderForm')
const fields = ['cliente','telefono','email','equipo','orden','fechaIngreso','fechaEstimada','estado','pagada','monto','abono','metodo','descripcion']
const saldo = el('saldo')

function computeSaldo(){
  const m = parseFloat(el('monto').value||'0')
  const a = parseFloat(el('abono').value||'0')
  const s = Math.max(0, m - a)
  saldo.value = s.toFixed(2)
}
el('monto').addEventListener('input', computeSaldo)
el('abono').addEventListener('input', computeSaldo)

form.addEventListener('submit', async (e)=>{
  e.preventDefault()
  // basic requireds
  for (const f of ['cliente','equipo','fechaIngreso','descripcion']){
    if(!el(f).value.trim()){ alert('Falta: ' + f); return }
  }
  computeSaldo()
  const data = Object.fromEntries(fields.map(f=>[f, el(f).value]))
  data.saldo = saldo.value
  const editingId = el('editingId').value
  if (editingId){
    data.id = Number(editingId)
    await db.put('orders', data)
    el('saveInfo').textContent = 'Actualizado ✓'
  } else {
    data.creado = new Date().toISOString()
    await db.add('orders', data)
    el('saveInfo').textContent = 'Guardado ✓'
  }
  await loadOrders()
  form.reset()
  saldo.value = ''
  el('editingId').value = ''
  setTimeout(()=> el('saveInfo').textContent = '', 1500)
})

el('resetBtn').addEventListener('click', ()=>{
  form.reset(); saldo.value=''; el('editingId').value=''
})

async function loadOrders(){
  const q = el('q').value.toLowerCase().trim()
  const fe = el('filterEstado').value
  const fp = el('filterPagada').value
  const tx = await db.getAll('orders')
  const rows = tx
    .filter(o => {
      const hay = !q || [o.cliente,o.orden,o.descripcion,o.equipo].some(v => (v||'').toLowerCase().includes(q))
      const okE = !fe || o.estado === fe
      const okP = !fp || o.pagada === fp
      return hay && okE && okP
    })
    .sort((a,b)=> (b.creado||'').localeCompare(a.creado||''))

  const tbody = document.getElementById('ordersBody')
  tbody.innerHTML = ''
  for (const o of rows){
    const tr = document.createElement('tr')
    const badge = o.pagada === 'Sí' ? '<span class="badge paid">Pagada</span>' : '<span class="badge unpaid">No pagada</span>'
    tr.innerHTML = `
      <td>${o.orden||'-'}</td>
      <td>${o.cliente||''}</td>
      <td>${o.equipo||''}</td>
      <td>${o.fechaIngreso||''}</td>
      <td>${o.estado||''}</td>
      <td>${badge}</td>
      <td>${(o.monto||'')}</td>
      <td class="row-actions">
        <button data-act="edit">Editar</button>
        <button data-act="toggle">${o.pagada==='Sí'?'Marcar No':'Marcar Sí'}</button>
        <button data-act="print">Ticket</button>
        <button data-act="delete" class="danger">Borrar</button>
      </td>
    `
    // actions
    tr.querySelector('[data-act="edit"]').addEventListener('click', ()=>{
      for (const f of fields){ el(f).value = o[f]||'' }
      saldo.value = o.saldo||''
      el('editingId').value = o.id
      window.scrollTo({top:0, behavior:'smooth'})
    })
    tr.querySelector('[data-act="toggle"]').addEventListener('click', async ()=>{
      o.pagada = o.pagada==='Sí'?'No':'Sí'
      await db.put('orders', o); await loadOrders()
    })
    tr.querySelector('[data-act="print"]').addEventListener('click', ()=> printTicket(o))
    tr.querySelector('[data-act="delete"]').addEventListener('click', async ()=>{
      if(confirm('¿Borrar esta orden?')){ await db.delete('orders', o.id); await loadOrders() }
    })
    tbody.appendChild(tr)
  }
}
['q','filterEstado','filterPagada'].forEach(id=> el(id).addEventListener('input', loadOrders))

function printTicket(o){
  const area = document.getElementById('printArea')
  area.innerHTML = `
  <div style="max-width:720px; margin:0 auto; padding:1rem; font-family: system-ui">
    <div style="display:flex; align-items:center; gap:.75rem; border-bottom:1px solid #ddd; padding-bottom:.5rem; margin-bottom:.5rem">
      <img src="icon-72.png" style="height:40px">
      <div>
        <div style="font-weight:700">Ride Tucson • Reparaciones</div>
        <div style="font-size:.9rem; color:#666">Orden ${o.orden||'-'}</div>
      </div>
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.35rem; font-size:.95rem">
      <div><b>Cliente:</b> ${o.cliente||''}</div>
      <div><b>Tel:</b> ${o.telefono||''}</div>
      <div><b>Email:</b> ${o.email||''}</div>
      <div><b>Equipo:</b> ${o.equipo||''}</div>
      <div><b>Ingreso:</b> ${o.fechaIngreso||''}</div>
      <div><b>Entrega estimada:</b> ${o.fechaEstimada||''}</div>
      <div><b>Estado:</b> ${o.estado||''}</div>
      <div><b>Pago:</b> ${o.pagada||''}</div>
    </div>
    <div style="margin:.5rem 0 0 0"><b>Descripción:</b><br>${(o.descripcion||'').replace(/\n/g,'<br>')}</div>
    <div style="margin-top:.75rem; display:grid; grid-template-columns: repeat(4,1fr); gap:.35rem">
      <div><b>Monto:</b> ${o.monto||''}</div>
      <div><b>Abono:</b> ${o.abono||''}</div>
      <div><b>Saldo:</b> ${o.saldo||''}</div>
      <div><b>Método:</b> ${o.metodo||''}</div>
    </div>
    <div style="margin-top:1rem; font-size:.85rem; color:#666">Gracias por su preferencia. Ride Tucson EBike & Bike Shop.</div>
  </div>`
  window.print()
}

document.getElementById('printBtn').addEventListener('click', ()=>{
  const o = Object.fromEntries(fields.map(f=>[f, el(f).value]))
  o.saldo = saldo.value
  printTicket(o)
})

// Export CSV
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  const rows = await db.getAll('orders')
  if(!rows.length){ alert('No hay datos para exportar'); return }
  const cols = ['id'] .concat(fields).concat(['saldo','creado'])
  const csv = [cols.join(',')].concat(rows.map(r=> cols.map(c=> `"${(r[c]??'').toString().replace(/"/g,'""')}"`).join(','))).join('\n')
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'})
  const url = URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url; a.download = 'reparaciones.csv'; a.click()
  URL.revokeObjectURL(url)
})

// Import CSV
document.getElementById('importFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]
  if(!file) return
  const text = await file.text()
  const lines = text.split(/\r?\n/).filter(Boolean)
  const header = lines.shift().split(',').map(h=> h.replace(/^"|"$/g,''))
  const rows = lines.map(line => {
    const parts = []
    let cur = '', inQ=false
    for (let i=0;i<line.length;i++){
      const ch = line[i]
      if(ch === '"' ){
        if (inQ && line[i+1]==='"'){ cur+='"'; i++ } else { inQ = !inQ }
      } else if(ch===',' and not inQ){
        parts.push(cur); cur=''
      } else { cur+=ch }
    }
    parts.push(cur)
    const obj = {}
    header.forEach((h,i)=> obj[h] = (parts[i]||'').replace(/^"|"$/g,''))
    if(obj.id) obj.id = Number(obj.id)
    return obj
  })
  // wipe & import
  if(!confirm('Esto reemplazará el listado existente. ¿Continuar?')) return
  const tx = db.transaction('orders','readwrite')
  const store = tx.objectStore('orders')
  // clear
  const keys = await store.getAllKeys()
  await Promise.all(keys.map(k=> store.delete(k)))
  // put
  for (const r of rows){ await store.put(r) }
  await tx.done
  await loadOrders()
  alert('Importación completa')
})

async function registerSW(){
  if('serviceWorker' in navigator){
    try { await navigator.serviceWorker.register('./sw.js') } catch(e){ console.warn(e) }
  }
}
registerSW()

// initial load
await loadOrders()
</script>
</body>
</html>
